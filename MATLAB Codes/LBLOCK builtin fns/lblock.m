function [ bit C ] = lblock( M,K,r,c )    % [a b]=lblock(zeros(1,64),zeros(1,80),32,1)
%M=[0 0 0 0 0 0 0 1 0 0 1 0 0 0 1 1 0 1 0 0 0 1 0 1 0 1 1 0 0 1 1 1 1 0 0 0 1 0 0 1 1 0 1 0 1 0 1 1 1 1 0 0 1 1 0 1 1 1 1 0 1 1 1 1];
%K=[0 0 0 0 0 0 0 1 0 0 1 0 0 0 1 1 0 1 0 0 0 1 0 1 0 1 1 0 0 1 1 1 1 0 0 0 1 0 0 1 1 0 1 0 1 0 1 1 1 1 0 0 1 1 0 1 1 1 1 0 1 1 1 1 1 1 1 1 1 1 1 0 1 1 0 1 1 1 0 0];
%M=zeros(1,64);
%K=zeros(1,80);


S0=[1 1 1 0;1 0 0 1;1 1 1 1;0 0 0 0;1 1 0 1;0 1 0 0;1 0 1 0;1 0 1 1;0 0 0 1;0 0 1 0;1 0 0 0;0 0 1 1;0 1 1 1;0 1 1 0;1 1 0 0;0 1 0 1];
S1=[0 1 0 0;1 0 1 1;1 1 1 0;1 0 0 1;1 1 1 1;1 1 0 1;0 0 0 0;1 0 1 0;0 1 1 1;1 1 0 0;0 1 0 1;0 1 1 0;0 0 1 0;1 0 0 0;0 0 0 1;0 0 1 1];
S2=[0 0 0 1;1 1 1 0;0 1 1 1;1 1 0 0;1 1 1 1;1 1 0 1;0 0 0 0;0 1 1 0;1 0 1 1;0 1 0 1;1 0 0 1;0 0 1 1;0 0 1 0;0 1 0 0;1 0 0 0;1 0 1 0];
S3=[0 1 1 1;0 1 1 0;1 0 0 0;1 0 1 1;0 0 0 0;1 1 1 1;0 0 1 1;1 1 1 0;1 0 0 1;1 0 1 0;1 1 0 0;1 1 0 1;0 1 0 1;0 0 1 0;0 1 0 0;0 0 0 1];
S4=[1 1 1 0;0 1 0 1;1 1 1 1;0 0 0 0;0 1 1 1;0 0 1 0;1 1 0 0;1 1 0 1;0 0 0 1;1 0 0 0;0 1 0 0;1 0 0 1;1 0 1 1;1 0 1 0;0 1 1 0;0 0 1 1];
S5=[0 0 1 0;1 1 0 1;1 0 1 1;1 1 0 0;1 1 1 1;1 1 1 0;0 0 0 0;1 0 0 1;0 1 1 1;1 0 1 0;0 1 1 0;0 0 1 1;0 0 0 1;1 0 0 0;0 1 0 0;0 1 0 1];
S6=[1 0 1 1;1 0 0 1;0 1 0 0;1 1 1 0;0 0 0 0;1 1 1 1;1 0 1 0;1 1 0 1;0 1 1 0;1 1 0 0;0 1 0 1;0 1 1 1;0 0 1 1;1 0 0 0;0 0 0 1;0 0 1 0];
S7=[1 1 0 1;1 0 1 0;1 1 1 1;0 0 0 0;1 1 1 0;0 1 0 0;1 0 0 1;1 0 1 1;0 0 1 0;0 0 0 1;1 0 0 0;0 0 1 1;0 1 1 1;0 1 0 1;1 1 0 0;0 1 1 0];
S8=[1 0 0 0;0 1 1 1;1 1 1 0;0 1 0 1;1 1 1 1;1 1 0 1;0 0 0 0;0 1 1 0;1 0 1 1;1 1 0 0;1 0 0 1;1 0 1 0;0 0 1 0;0 1 0 0;0 0 0 1;0 0 1 1];
S9=[1 0 1 1;0 1 0 1;1 1 1 1;0 0 0 0;0 1 1 1;0 0 1 0;1 0 0 1;1 1 0 1;0 1 0 0;1 0 0 0;0 0 0 1;1 1 0 0;1 1 1 0;1 0 1 0;0 0 1 1;0 1 1 0];

SK(1,:)=K(1:32);    %SK1=K(1:32)

for i=1:r-1
    K=circshift(K',-29)';
    K(1:4)=S9(bi2de(K(1:4),'left-msb')+1,:);            % S9
    K(5:8)=S8(bi2de(K(5:8),'left-msb')+1,:);            % S8
    K(30:34)=xor(K(30:34),de2bi(i,5,'left-msb'));
    SK(i+1,:)=K(1:32);
end

X(2,:)=M(1:32);X(1,:)=M(33:64);     % M=X2||X1
for i=3:r+2
    XK=xor(X(i-1,:),SK(i-2,:));       % X2+SK1
    
    XK(1:4)=S7(bi2de(XK(1:4),'left-msb')+1,:);          % S7
    XK(5:8)=S6(bi2de(XK(5:8),'left-msb')+1,:);          % S6
    XK(9:12)=S5(bi2de(XK(9:12),'left-msb')+1,:);        % S5
    XK(13:16)=S4(bi2de(XK(13:16),'left-msb')+1,:);      % S4
    XK(17:20)=S3(bi2de(XK(17:20),'left-msb')+1,:);      % S3
    XK(21:24)=S2(bi2de(XK(21:24),'left-msb')+1,:);      % S2
    XK(25:28)=S1(bi2de(XK(25:28),'left-msb')+1,:);      % S1
    XK(29:32)=S0(bi2de(XK(29:32),'left-msb')+1,:);      % S0
 
    F=[XK(5:8) XK(13:16) XK(1:4) XK(9:12) XK(21:24) XK(29:32) XK(17:20) XK(25:28)];     % Permutation
    X(i,:)=xor(F,circshift(X(i-2,:)',-8)');
end
C=[X(i-1,:) X(i,:)];    % C=X33||X34
bit=C(c);
end