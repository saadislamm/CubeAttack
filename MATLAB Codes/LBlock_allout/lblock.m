function C = lblock(M,K,r)    % [a b]=lblock(zeros(1,64),zeros(1,80),32,1)
%M=[0 0 0 0 0 0 0 1 0 0 1 0 0 0 1 1 0 1 0 0 0 1 0 1 0 1 1 0 0 1 1 1 1 0 0 0 1 0 0 1 1 0 1 0 1 0 1 1 1 1 0 0 1 1 0 1 1 1 1 0 1 1 1 1];
%K=[0 0 0 0 0 0 0 1 0 0 1 0 0 0 1 1 0 1 0 0 0 1 0 1 0 1 1 0 0 1 1 1 1 0 0 0 1 0 0 1 1 0 1 0 1 0 1 1 1 1 0 0 1 1 0 1 1 1 1 0 1 1 1 1 1 1 1 1 1 1 1 0 1 1 0 1 1 1 0 0];
%M=zeros(1,64);
%K=zeros(1,80);

SK=zeros(r,32);
SK(1,:)=K(1:32);    %SK1=K(1:32)
ii=[0 0 0 0 1; 0 0 0 1 0; 0 0 0 1 1; 0 0 1 0 0; 0 0 1 0 1; 0 0 1 1 0; 0 0 1 1 1; 0 1 0 0 0; 0 1 0 0 1; 0 1 0 1 0; 0 1 0 1 1; 0 1 1 0 0; 0 1 1 0 1; 0 1 1 1 0; 0 1 1 1 1; 1 0 0 0 0; 1 0 0 0 1; 1 0 0 1 0; 1 0 0 1 1; 1 0 1 0 0; 1 0 1 0 1; 1 0 1 1 0; 1 0 1 1 1; 1 1 0 0 0; 1 1 0 0 1; 1 1 0 1 0; 1 1 0 1 1; 1 1 1 0 0; 1 1 1 0 1; 1 1 1 1 0; 1 1 1 1 1];

for i=1:r-1
    K=[K(30:80) K(1:29)];
    K(1:4)=S9(K(1:4));            % S9
    K(5:8)=S8(K(5:8));            % S8
    K(30:34)=xor(K(30:34),ii(i,:));
    SK(i+1,:)=K(1:32);
end

X=zeros(r+2,32);
X(2,:)=M(1:32);X(1,:)=M(33:64);     % M=X2||X1
for i=3:r+2
    XK=xor(X(i-1,:),SK(i-2,:));       % X2+SK1
    
    F(9:12)=S7(XK(1:4));          % S7           +Permutation
    F(1:4)=S6(XK(5:8));          % S6
    F(13:16)=S5(XK(9:12));        % S5
    F(5:8)=S4(XK(13:16));      % S4
    F(25:28)=S3(XK(17:20));      % S3
    F(17:20)=S2(XK(21:24));      % S2
    F(29:32)=S1(XK(25:28));      % S1
    F(21:24)=S0(XK(29:32));      % S0
 
    z=X(i-2,:);
    X(i,:)=xor(F,[z(9:32) z(1:8)]);
end
C=[X(i-1,:) X(i,:)];    % C=X33||X34
end